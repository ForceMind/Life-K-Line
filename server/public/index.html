<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life K-Line å¡å¯†ç®¡ç†åå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div id="app" class="max-w-6xl mx-auto">
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <h1 class="text-2xl font-bold mb-4 text-gray-800">ğŸ”‘ å¡å¯†ç®¡ç†åå°</h1>
            
            <!-- Login -->
            <div v-if="!isLoggedIn" class="max-w-md mx-auto mt-10">
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <h2 class="text-lg font-bold mb-4">ç®¡ç†å‘˜ç™»å½•</h2>
                    <div class="space-y-4">
                        <input v-model="loginForm.username" type="text" placeholder="ç”¨æˆ·å" class="w-full border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                        <input v-model="loginForm.password" type="password" placeholder="å¯†ç " class="w-full border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                        <button @click="login" class="w-full bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">ç™»å½•</button>
                    </div>
                </div>
            </div>

            <!-- Dashboard -->
            <div v-else>
                <div class="flex justify-between items-center mb-6">
                    <div class="text-sm text-gray-500">ç®¡ç†å‘˜: {{ loginForm.username }}</div>
                    <div class="flex gap-4">
                        <button @click="showSettings = true" class="text-blue-600 text-sm hover:underline">ç³»ç»Ÿè®¾ç½®</button>
                        <button @click="logout" class="text-red-500 text-sm hover:underline">é€€å‡º</button>
                    </div>
                </div>

                <!-- Settings Modal -->
                <div v-if="showSettings" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
                        <h2 class="text-xl font-bold mb-4">ç³»ç»Ÿè®¾ç½®</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æœåŠ¡ç«¯å£ (PORT)</label>
                                <input v-model="configForm.PORT" type="number" class="w-full border rounded px-3 py-2" placeholder="3000">
                                <p class="text-xs text-red-500 mt-1">âš ï¸ ä¿®æ”¹ç«¯å£ä¼šå¯¼è‡´æœåŠ¡é‡å¯ï¼Œéœ€è¦ä½¿ç”¨æ–°ç«¯å£é‡æ–°è®¿é—®ã€‚</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ç®¡ç†å‘˜ç”¨æˆ·å</label>
                                <input v-model="configForm.ADMIN_USER" type="text" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ç®¡ç†å‘˜å¯†ç </label>
                                <input v-model="configForm.ADMIN_PASS" type="password" placeholder="ä¸ä¿®æ”¹è¯·ç•™ç©º" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">åå°ç®¡ç†è·¯å¾„ (Admin Path)</label>
                                <input v-model="configForm.ADMIN_PATH" type="text" class="w-full border rounded px-3 py-2" placeholder="/admin">
                                <p class="text-xs text-red-500 mt-1">âš ï¸ ä¿®æ”¹åæœåŠ¡ä¼šé‡å¯ï¼Œè¯·åŠ¡å¿…è®°ä½æ–°è·¯å¾„ï¼</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">DeepSeek API Key</label>
                                <input v-model="configForm.DEEPSEEK_API_KEY" type="password" placeholder="ä¸ä¿®æ”¹è¯·ç•™ç©º" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">DeepSeek Base URL</label>
                                <input v-model="configForm.DEEPSEEK_BASE_URL" type="text" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡å‹åç§° (Model Name)</label>
                                <input v-model="configForm.DEEPSEEK_MODEL" type="text" placeholder="deepseek-chat" class="w-full border rounded px-3 py-2">
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button @click="showSettings = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">å–æ¶ˆ</button>
                            <button @click="saveConfig" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ä¿å­˜é…ç½®</button>
                        </div>
                    </div>
                </div>

                <!-- Generator -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-8">
                    <h2 class="font-bold text-gray-700 mb-3">ç”Ÿæˆæ–°å¡å¯†</h2>
                    <div class="flex gap-4 items-center flex-wrap">
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-600">æ•°é‡:</label>
                            <input v-model.number="generateCount" type="number" min="1" max="100" class="w-20 border border-gray-300 rounded px-2 py-1">
                        </div>
                        <button @click="generateCards" :disabled="loading" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition disabled:opacity-50">
                            {{ loading ? 'ç”Ÿæˆä¸­...' : 'ä¸€é”®ç”Ÿæˆ' }}
                        </button>
                    </div>
                    <!-- New Cards Result -->
                    <div v-if="newCards.length" class="mt-4">
                        <div class="flex justify-between items-center mb-2">
                            <div class="text-sm text-green-600">ç”ŸæˆæˆåŠŸï¼</div>
                            <button @click="copyNewCards" class="text-blue-600 text-xs hover:underline">å¤åˆ¶å…¨éƒ¨</button>
                        </div>
                        <textarea readonly class="w-full h-32 p-3 border border-gray-300 rounded font-mono text-sm bg-white" :value="newCards.join('\n')"></textarea>
                    </div>
                </div>

                <!-- List -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-gray-700">å¡å¯†åˆ—è¡¨ ({{ filteredCards.length }})</h2>
                        <div class="flex gap-4 items-center">
                            <input v-model="searchQuery" type="text" placeholder="æœç´¢å¡å¯†..." class="border border-gray-300 rounded px-3 py-1 text-sm focus:outline-none focus:border-blue-500">
                            <select v-model="filterStatus" class="border border-gray-300 rounded px-3 py-1 text-sm focus:outline-none focus:border-blue-500">
                                <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="unused">æœªä½¿ç”¨</option>
                                <option value="active">ä½¿ç”¨ä¸­</option>
                                <option value="used">å·²å¤±æ•ˆ</option>
                            </select>
                            <div class="flex gap-2">
                                <button @click="exportCSV" class="text-green-600 text-sm hover:underline">å¯¼å‡ºCSV</button>
                                <button @click="fetchCards" class="text-blue-600 text-sm hover:underline">åˆ·æ–°åˆ—è¡¨</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 text-gray-600 text-sm">
                                    <th @click="sortBy('id')" class="p-3 border-b cursor-pointer hover:bg-gray-100">ID <span v-if="sortKey === 'id'">{{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}</span></th>
                                    <th @click="sortBy('code')" class="p-3 border-b cursor-pointer hover:bg-gray-100">å¡å¯† <span v-if="sortKey === 'code'">{{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}</span></th>
                                    <th @click="sortBy('status')" class="p-3 border-b cursor-pointer hover:bg-gray-100">çŠ¶æ€ <span v-if="sortKey === 'status'">{{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}</span></th>
                                    <th @click="sortBy('bazi_count')" class="p-3 border-b cursor-pointer hover:bg-gray-100">å…«å­—æ¶ˆè€—/APIè°ƒç”¨ <span v-if="sortKey === 'bazi_count'">{{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}</span></th>
                                    <th @click="sortBy('created_at')" class="p-3 border-b cursor-pointer hover:bg-gray-100">åˆ›å»ºæ—¶é—´ <span v-if="sortKey === 'created_at'">{{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}</span></th>
                                    <th @click="sortBy('activated_at')" class="p-3 border-b cursor-pointer hover:bg-gray-100">æ¿€æ´»æ—¶é—´ <span v-if="sortKey === 'activated_at'">{{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}</span></th>
                                    <th class="p-3 border-b">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">
                                <tr v-for="card in filteredCards" :key="card.id" class="hover:bg-gray-50 border-b last:border-0">
                                    <td class="p-3 text-gray-500">{{ card.id }}</td>
                                    <td class="p-3 font-mono font-bold text-gray-800">{{ card.code }}</td>
                                    <td class="p-3">
                                        <span :class="{
                                            'bg-green-100 text-green-800': getCardStatus(card) === 'unused',
                                            'bg-blue-100 text-blue-800': getCardStatus(card) === 'active',
                                            'bg-yellow-100 text-yellow-800': getCardStatus(card) === 'expired',
                                            'bg-gray-100 text-gray-800': getCardStatus(card) === 'used'
                                        }" class="px-2 py-1 rounded text-xs">
                                            {{ statusMap[getCardStatus(card)] }}
                                        </span>
                                    </td>
                                    <td class="p-3 text-gray-800">
                                        <span class="font-bold" :class="{'text-red-600': card.bazi_count >= 3}">{{ card.bazi_count || 0 }}/3</span>
                                        <span class="text-gray-400 text-xs ml-1">({{ card.use_count || 0 }}æ¬¡)</span>
                                    </td>
                                    <td class="p-3 text-gray-500">{{ formatDate(card.created_at) }}</td>
                                    <td class="p-3 text-gray-500">{{ formatDate(card.activated_at) }}</td>
                                    <td class="p-3 flex gap-2">
                                        <button @click="viewLogs(card)" class="text-blue-600 hover:underline text-xs">æ—¥å¿—</button>
                                        <button v-if="getCardStatus(card) !== 'used' && getCardStatus(card) !== 'expired'" @click="voidCard(card)" class="text-red-600 hover:underline text-xs">ä½œåºŸ</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Modal -->
        <div v-if="showLogsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[80vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="font-bold">ä½¿ç”¨æ—¥å¿— - {{ currentCard?.code }}</h3>
                    <button @click="showLogsModal = false" class="text-gray-500 hover:text-gray-700">âœ•</button>
                </div>
                <div class="p-4 overflow-y-auto flex-1">
                    <table class="w-full text-left text-sm">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600">
                                <th class="p-2">æ—¶é—´</th>
                                <th class="p-2">IP</th>
                                <th class="p-2">è®¾å¤‡/æµè§ˆå™¨</th>
                                <th class="p-2">æ•°æ®</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="log in currentLogs" :key="log.id" class="border-b">
                                <td class="p-2">{{ formatDate(log.timestamp) }}</td>
                                <td class="p-2 font-mono">{{ log.ip }}</td>
                                <td class="p-2 truncate max-w-xs" :title="log.user_agent">{{ log.user_agent }}</td>
                                <td class="p-2">
                                    <button @click="showLogDetail(log)" class="text-blue-600 hover:underline text-xs">æŸ¥çœ‹è¯¦æƒ…</button>
                                </td>
                            </tr>
                            <tr v-if="currentLogs.length === 0">
                                <td colspan="4" class="p-4 text-center text-gray-500">æš‚æ— ä½¿ç”¨è®°å½•</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Log Detail Modal -->
        <div v-if="showDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60]">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="font-bold">è¯·æ±‚è¯¦æƒ…</h3>
                    <button @click="showDetailModal = false" class="text-gray-500 hover:text-gray-700">âœ•</button>
                </div>
                <div class="p-4 overflow-y-auto flex-1 grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-bold mb-2 text-gray-700">è¾“å…¥ (Prompt)</h4>
                        <pre class="bg-gray-50 p-3 rounded text-xs overflow-auto h-96 whitespace-pre-wrap">{{ formatJson(currentLogDetail?.input_data) }}</pre>
                    </div>
                    <div>
                        <h4 class="font-bold mb-2 text-gray-700">è¾“å‡º (AI Response)</h4>
                        <pre class="bg-gray-50 p-3 rounded text-xs overflow-auto h-96 whitespace-pre-wrap">{{ formatJson(currentLogDetail?.output_data) }}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, computed } = Vue;

        createApp({
            setup() {
                const loginForm = ref({ username: '', password: '' });
                const token = ref(localStorage.getItem('admin_token') || '');
                const isLoggedIn = ref(false);
                const cards = ref([]);
                const generateCount = ref(1);
                const newCards = ref([]);
                const loading = ref(false);
                const showLogsModal = ref(false);
                const showSettings = ref(false);
                const showDetailModal = ref(false);
                const currentCard = ref(null);
                const currentLogs = ref([]);
                const currentLogDetail = ref(null);
                const configForm = ref({});
                
                // Sorting & Filtering
                const searchQuery = ref('');
                const filterStatus = ref('all');
                const sortKey = ref('created_at');
                const sortOrder = ref('desc');

                const statusMap = {
                    'unused': 'æœªä½¿ç”¨',
                    'active': 'ä½¿ç”¨ä¸­',
                    'expired': 'å·²è¿‡æœŸ',
                    'used': 'å·²å¤±æ•ˆ'
                };

                const getCardStatus = (card) => {
                    if (card.status === 'used') return 'used';
                    if (card.status === 'active') {
                        const now = new Date();
                        const expiresAt = new Date(card.expires_at);
                        if (now > expiresAt) return 'expired';
                        return 'active';
                    }
                    return 'unused';
                };

                const filteredCards = computed(() => {
                    let result = cards.value;

                    // Filter
                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        result = result.filter(c => c.code.toLowerCase().includes(q));
                    }
                    if (filterStatus.value !== 'all') {
                        result = result.filter(c => getCardStatus(c) === filterStatus.value);
                    }

                    // Sort
                    result.sort((a, b) => {
                        let valA = a[sortKey.value];
                        let valB = b[sortKey.value];
                        
                        // Handle nulls
                        if (valA === null || valA === undefined) valA = '';
                        if (valB === null || valB === undefined) valB = '';

                        if (valA < valB) return sortOrder.value === 'asc' ? -1 : 1;
                        if (valA > valB) return sortOrder.value === 'asc' ? 1 : -1;
                        return 0;
                    });

                    return result;
                });

                const sortBy = (key) => {
                    if (sortKey.value === key) {
                        sortOrder.value = sortOrder.value === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortKey.value = key;
                        sortOrder.value = 'desc'; // Default desc for new sort
                    }
                };

                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    return new Date(dateStr).toLocaleString();
                };

                const formatJson = (str) => {
                    if (!str) return 'æ— æ•°æ®';
                    try {
                        return JSON.stringify(JSON.parse(str), null, 2);
                    } catch (e) {
                        return str;
                    }
                };


                const getHeaders = () => ({
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token.value}`
                });

                const login = async () => {
                    try {
                        const res = await fetch('/api/admin/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(loginForm.value)
                        });
                        if (res.ok) {
                            const data = await res.json();
                            token.value = data.token;
                            localStorage.setItem('admin_token', data.token);
                            
                            // Force reactivity update
                            isLoggedIn.value = true;
                            
                            // Immediately fetch data to populate dashboard
                            await fetchCards();
                            await fetchConfig();
                        } else {
                            alert('ç™»å½•å¤±è´¥');
                        }
                    } catch (e) {
                        alert('ç™»å½•é”™è¯¯');
                    }
                };

                const logout = () => {
                    localStorage.removeItem('admin_token');
                    token.value = '';
                    isLoggedIn.value = false;
                    cards.value = [];
                    loginForm.value = { username: '', password: '' };
                };

                const fetchConfig = async () => {
                    try {
                        const res = await fetch('/api/admin/config', { headers: getHeaders() });
                        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                        const data = await res.json();
                        configForm.value = {
                            PORT: data.PORT,
                            ADMIN_USER: data.ADMIN_USER,
                            ADMIN_PATH: data.ADMIN_PATH,
                            ADMIN_PASS: '', // Don't show password
                            DEEPSEEK_API_KEY: '', // Don't show full key
                            DEEPSEEK_BASE_URL: data.DEEPSEEK_BASE_URL,
                            DEEPSEEK_MODEL: data.DEEPSEEK_MODEL
                        };
                    } catch (e) {
                        console.error('Fetch config failed', e);
                    }
                };

                const saveConfig = async () => {
                    try {
                        const body = { ...configForm.value };
                        // Remove empty fields to avoid overwriting with empty strings
                        if (!body.ADMIN_PASS) delete body.ADMIN_PASS;
                        if (!body.DEEPSEEK_API_KEY) delete body.DEEPSEEK_API_KEY;

                        const res = await fetch('/api/admin/config', {
                            method: 'POST',
                            headers: getHeaders(),
                            body: JSON.stringify(body)
                        });
                        
                        if (res.ok) {
                            const data = await res.json();
                            
                            if (data.restartRequired) {
                                alert('é…ç½®å·²ä¿å­˜ã€‚æœåŠ¡æ­£åœ¨é‡å¯ä»¥åº”ç”¨æ–°ç«¯å£ï¼Œè¯·ç¨åä½¿ç”¨æ–°ç«¯å£è®¿é—®ã€‚');
                                showSettings.value = false;
                                return;
                            }

                            alert('é…ç½®å·²ä¿å­˜');
                            showSettings.value = false;
                            if (data.token) {
                                token.value = data.token;
                                localStorage.setItem('admin_token', data.token);
                                // Update login form if user changed
                                if (body.ADMIN_USER) loginForm.value.username = body.ADMIN_USER;
                            }
                            fetchConfig();
                        } else {
                            alert('ä¿å­˜å¤±è´¥');
                        }
                    } catch (e) {
                        alert('ä¿å­˜é”™è¯¯');
                    }
                };

                const fetchCards = async () => {
                    try {
                        const res = await fetch('/api/admin/cards', { headers: getHeaders() });
                        if (res.status === 401) {
                            console.error('Fetch cards 401 Unauthorized');
                            // Only logout if we are sure it's a token issue, but for now let's just alert
                            // logout(); 
                            // return;
                            if (isLoggedIn.value) {
                                alert('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                                logout();
                            }
                            return;
                        }
                        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                        const data = await res.json();
                        cards.value = data.cards;
                        // isLoggedIn.value = true; // No need to set here
                    } catch (e) {
                        console.error('Fetch cards error:', e);
                    }
                };

                const generateCards = async () => {
                    loading.value = true;
                    newCards.value = [];
                    try {
                        const res = await fetch('/api/admin/generate-cards', {
                            method: 'POST',
                            headers: getHeaders(),
                            body: JSON.stringify({ count: generateCount.value })
                        });
                        const data = await res.json();
                        newCards.value = data.cards;
                        await fetchCards();
                    } catch (e) {
                        alert(e.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const viewLogs = async (card) => {
                    currentCard.value = card;
                    currentLogs.value = [];
                    showLogsModal.value = true;
                    try {
                        const res = await fetch(`/api/admin/logs/${card.code}`, { headers: getHeaders() });
                        const data = await res.json();
                        currentLogs.value = data.logs;
                    } catch (e) {
                        alert('è·å–æ—¥å¿—å¤±è´¥');
                    }
                };

                const voidCard = async (card) => {
                    if (!confirm(`ç¡®å®šè¦ä½œåºŸå¡å¯† ${card.code} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;
                    try {
                        const res = await fetch(`/api/admin/cards/${card.code}/void`, {
                            method: 'POST',
                            headers: getHeaders()
                        });
                        if (res.ok) {
                            alert('å¡å¯†å·²ä½œåºŸ');
                            fetchCards();
                        } else {
                            alert('æ“ä½œå¤±è´¥');
                        }
                    } catch (e) {
                        alert('æ“ä½œé”™è¯¯');
                    }
                };

                const copyNewCards = async () => {
                    try {
                        await navigator.clipboard.writeText(newCards.value.join('\n'));
                        alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    } catch (err) {
                        // Fallback for non-secure contexts (http)
                        const textArea = document.createElement("textarea");
                        textArea.value = newCards.value.join('\n');
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                        } catch (err) {
                            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                        }
                        document.body.removeChild(textArea);
                    }
                };

                const showLogDetail = (log) => {
                    currentLogDetail.value = log;
                    showDetailModal.value = true;
                };

                const exportCSV = () => {
                    const headers = ['ID', 'å¡å¯†', 'çŠ¶æ€', 'å·²ç”¨å…«å­—æ•°', 'APIè°ƒç”¨æ¬¡æ•°', 'åˆ›å»ºæ—¶é—´', 'æ¿€æ´»æ—¶é—´'];
                    const rows = cards.value.map(c => [
                        c.id,
                        c.code,
                        statusMap[c.status] || c.status,
                        c.bazi_count || 0,
                        c.use_count || 0,
                        formatDate(c.created_at),
                        formatDate(c.activated_at)
                    ]);
                    const csvContent = "\uFEFF" + [headers, ...rows].map(e => e.join(',')).join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'cards_export.csv';
                    link.click();
                };

                onMounted(() => {
                    if (token.value) {
                        fetchCards();
                        fetchConfig();
                    }
                });

                return {
                    loginForm,
                    isLoggedIn,
                    cards,
                    generateCount,
                    newCards,
                    loading,
                    statusMap,
                    showLogsModal,
                    showSettings,
                    showDetailModal,
                    currentCard,
                    currentLogs,
                    currentLogDetail,
                    configForm,
                    login,
                    logout,
                    fetchCards,
                    generateCards,
                    viewLogs,
                    showLogDetail,
                    copyNewCards,
                    exportCSV,
                    formatDate,
                    saveConfig,
                    formatJson,
                    // New
                    searchQuery,
                    filterStatus,
                    sortKey,
                    sortOrder,
                    filteredCards,
                    sortBy,
                    voidCard,
                    getCardStatus
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
